filename_ghcn_label = gsub(":", "-", filename_ghcn_label)
file_title_string = paste(filename_ghcn_label,
"__",
filename_station_label,
sep="")
remove(ncdc_data)
if ("TMAX" %in% available_datafields)  {
tmax_full_field          = sorted_data$tmax
ordered                = order(tmax_full_field$date)
tmax_full_field$tmax[] = tmax_full_field$tmax[ordered] / 10
tmax_full_field$date[] = tmax_full_field$date[ordered]
}
if ("TMIN" %in% available_datafields)  {
tmin_full_field          = sorted_data$tmin
ordered                = order(tmin_full_field$date)
tmin_full_field$tmin[] = tmin_full_field$tmin[ordered] / 10
tmin_full_field$date[] = tmin_full_field$date[ordered]
}
if ("PRCP" %in% available_datafields)  {
prcp_full_field          = sorted_data$prcp
ordered                = order(prcp_full_field$date)
prcp_full_field$prcp[] = prcp_full_field$prcp[ordered] / 10
prcp_full_field$date[] = prcp_full_field$date[ordered]
}
if ("SNOW" %in% available_datafields)  {
snow_full_field          = sorted_data$snow
ordered                = order(snow_full_field$date)
snow_full_field$snow[] = snow_full_field$snow[ordered]
snow_full_field$date[] = snow_full_field$date[ordered]
}
if ("SNWD" %in% available_datafields)  {
snwd_full_field          = sorted_data$snwd
ordered                = order(snwd_full_field$date)
snwd_full_field$snwd[] = snwd_full_field$snwd[ordered]
snwd_full_field$date[] = snwd_full_field$date[ordered]
}
remove(sorted_data,
ordered)
Days_from_1970_01_01 = as.numeric( as.Date(Date) )
index_days           = Days_from_1970_01_01      -
min(Days_from_1970_01_01) +
1
new_variable   = Days_from_1970_01_01
new_variable[] = NA
if ("TMAX" %in% available_datafields)  {
tmax             = new_variable
index_tmax       = as.numeric(tmax_full_field$date) - Days_from_1970_01_01[1] + 1
index_tmax       = index_tmax[which(index_tmax <= max(index_days)) ]
index_tmax       = index_tmax[which(index_tmax >= min(index_days)) ]
tmax[index_tmax] = tmax_full_field$tmax[index_tmax]
remove(tmax_full_field,
index_tmax)
}
if ("TMIN" %in% available_datafields)  {
tmin             = new_variable
index_tmin       = as.numeric(tmin_full_field$date) - Days_from_1970_01_01[1] + 1
index_tmin       = index_tmin[which(index_tmin <= max(index_days)) ]
index_tmin       = index_tmin[which(index_tmin >= min(index_days)) ]
tmin[index_tmin] = tmin_full_field$tmin[index_tmin]
remove(tmin_full_field,
index_tmin)
}
if ("PRCP" %in% available_datafields)  {
prcp             = new_variable
index_prcp       = as.numeric(prcp_full_field$date) - Days_from_1970_01_01[1] + 1
index_prcp       = index_prcp[which(index_prcp <= max(index_days)) ]
index_prcp       = index_prcp[which(index_prcp >= min(index_days)) ]
prcp[index_prcp] = prcp_full_field$prcp[index_prcp]
remove(prcp_full_field,
index_prcp)
}
if ("SNOW" %in% available_datafields)  {
snow             = new_variable
index_snow       = as.numeric(snow_full_field$date) - Days_from_1970_01_01[1] + 1
index_snow       = index_snow[which(index_snow <= max(index_days)) ]
index_snow       = index_snow[which(index_snow >= min(index_days)) ]
snow[index_snow] = snow_full_field$snow[index_snow]
remove(snow_full_field,
index_snow)
}
if ("SNWD" %in% available_datafields)  {
snwd             = new_variable
index_snwd       = as.numeric(snwd_full_field$date) - Days_from_1970_01_01[1] + 1
index_snwd       = index_snwd[which(index_snwd <= max(index_days)) ]
index_snwd       = index_snwd[which(index_snwd >= min(index_days)) ]
snwd[index_snwd] = snwd_full_field$snwd[index_snwd]
remove(snwd_full_field,
index_snwd)
}
remove(new_variable,
index_days)
if ("TMAX" %in% available_datafields)  {
plot(x       = Date,
y       = tmax,
type    = "p",
pch     = ".",   # as points
col     = "red",
lwd     = 1.5,
cex.lab = 1.25,
xlab    = "Date",
ylab    = "Max Temperature (deg C)",
main    = station_name_label)
}
if ("TMIN" %in% available_datafields)  {
plot(x       = Date,
y       = tmin,
type    = "p",
pch     = ".",   # as points
col     = "darkgreen",
lwd     = 1.5,
cex.lab = 1.25,
xlab    = "Date",
ylab    = "Min Temperature (deg C)",
main    = station_name_label)
}
if ("PRCP" %in% available_datafields)  {
plot(x       = Date,
y       = prcp,
type    = "p",
pch     = ".",   # as points
col     = "green",
lwd     = 1.5,
cex.lab = 1.25,
xlab    = "Date",
ylab    = "Daily Precip (mm)",
main    = station_name_label)
}
if ("SNOW" %in% available_datafields)  {
plot(x       = Date,
y       = snow,
type    = "p",
pch     = ".",   # as points
col     = "cyan",
lwd     = 1.5,
cex.lab = 1.25,
xlab    = "Date",
ylab    = "Daily Snowfall (mm)",
main    = station_name_label)
}
if ("SNWD" %in% available_datafields)  {
plot(x       = Date,
y       = snwd,
type    = "p",
pch     = ".",   # as points
col     = "darkblue",
lwd     = 1.5,
cex.lab = 1.25,
xlab    = "Date",
ylab    = "Daily Snowfall (mm)",
main    = station_name_label)
}
targ_time_series_raw = data.frame(date = Date)
if ("TMAX" %in% available_datafields)
targ_time_series_raw$max_temperature = tmax
if ("TMIN" %in% available_datafields)
targ_time_series_raw$min_temperature = tmin
if ("PRCP" %in% available_datafields)
targ_time_series_raw$precipitation   = prcp
if ("SNOW" %in% available_datafields)
targ_time_series_raw$snowfall        = snow
if ("SNWD" %in% available_datafields)
targ_time_series_raw$snowdepth       = snwd
output_file_name = paste(file_title_string,
".csv",
sep="")
write.table(x    = targ_time_series_raw,
file = output_file_name,
sep  =", ",
row.names = FALSE)
remove(targ_time_series_raw)
netcdf_time_dim  = ncdim_def(name  = "time",
units = "days since 1970-01-01 00:00:00",
val   = Days_from_1970_01_01,
unlim = TRUE,
calendar="standard")
fill_value = 9.96921e+36
netcdf_lat      = ncvar_def(nam      = "latitude",
units    = "degrees_north",
dim      = list(),
missval  = fill_value,
longname = "Latitude",
prec     = "single")
netcdf_lon      = ncvar_def(nam      = "longitude",
units    = "degrees_east",
dim      = list(),
missval  = fill_value,
longname = "Longitue",
prec     = "single")
netcdf_alt      = ncvar_def(nam      = "altitude",
units    = "m",
dim      = list(),
missval  = fill_value,
longname = "Elevation",
prec     = "single")
netcdf_available_variables = list(netcdf_lat,
netcdf_lon,
netcdf_alt)
if ("TMAX" %in% available_datafields) {
netcdf_tmax      = ncvar_def(nam      = "maximum_air_temperature",
units    = "deg C",
dim      = netcdf_time_dim,
missval  = fill_value,
longname = "2-m Maximum Daily Air Temperature",
prec     = "single")
netcdf_available_variables = list(netcdf_available_variables,
netcdf_tmax)
}
if ("TMIN" %in% available_datafields) {
netcdf_tmin      = ncvar_def(nam      = "minimum_air_temperature",
units    = "deg C",
dim      = netcdf_time_dim,
missval  = fill_value,
longname = "2-m Minimium Daily Air Temperature",
prec     = "single")
netcdf_available_variables = list(netcdf_available_variables,
netcdf_tmin)
}
if ("PRCP" %in% available_datafields) {
netcdf_prcp      = ncvar_def(nam      = "precipitation_amount",
units    = "kg m-2",
dim      = netcdf_time_dim,
missval  = fill_value,
longname = "Daily Total Precipitation",
prec     = "single")
netcdf_available_variables = list(netcdf_available_variables,
netcdf_prcp)
}
if ("SNOW" %in% available_datafields) {
netcdf_snow      = ncvar_def(nam      = "snowfall_amount",
units    = "kg m-2",
dim      = netcdf_time_dim,
missval  = fill_value,
longname = "Daily Total Snowfall",
prec     = "single")
netcdf_available_variables = list(netcdf_available_variables,
netcdf_snow)
}
if ("SNWD" %in% available_datafields) {
netcdf_snwd      = ncvar_def(nam      = "surface_snow_thickness",
units    = "mm",
dim      = netcdf_time_dim,
missval  = fill_value,
longname = "Snow Depth on Surface",
prec     = "single")
netcdf_available_variables = list(netcdf_available_variables,
netcdf_snwd)
}
netcdf_available_variables
View(netcdf_available_variables)
View(netcdf_available_variables)
library("rnoaa")
library("isdparser")
library("lubridate")
library("ncdf4")
library("dplyr")
library("openair")
working_year = 1980
ncdc_ids = ncdc_stations(locationid = 'CITY:US460006',
datasetid  = 'GHCND',
limit      = 1000)
n_stations = ncdc_ids$meta$pageCount
ncdc_ids = ncdc_ids$data
ncdc_ids
total_number_of_stations = length(ncdc_ids$name)
ncdc_index = 1  #20
station_name_label     = ncdc_ids$name[ncdc_index]
station_latitude       = ncdc_ids$latitude[ncdc_index]
station_longitude      = ncdc_ids$longitude[ncdc_index]
station_altitude       = ncdc_ids$elevation[ncdc_index]
ncdc_id_code = ncdc_ids$id[ncdc_index]
ghcn_station_code = unlist(strsplit(x      = ncdc_id_code,
split  = ":"))
ncdc_start_yymmdd = ncdc_ids$mindate[ncdc_index]
ncdc_end_yymmdd   = ncdc_ids$maxdate[ncdc_index]
Date = seq(from = as.Date(ncdc_start_yymmdd),
to   = as.Date(ncdc_end_yymmdd),
by   = "days")
ncdc_data = ghcnd(stationid = ghcn_station_code[2])
available_datafields = unique(ncdc_data$element)
sorted_data = ghcnd_splitvars(ncdc_data)
filename_station_label = ncdc_ids$name[ncdc_index]
filename_station_label = gsub(" US",  "",  filename_station_label)
filename_station_label = gsub(  ",",  "",  filename_station_label)
filename_station_label = gsub(  " ", "_",  filename_station_label)
filename_ghcn_label = ncdc_ids$id[ncdc_index]
filename_ghcn_label = gsub(":", "-", filename_ghcn_label)
file_title_string = paste(filename_ghcn_label,
"__",
filename_station_label,
sep="")
remove(ncdc_data)
if ("TMAX" %in% available_datafields)  {
tmax_full_field          = sorted_data$tmax
ordered                = order(tmax_full_field$date)
tmax_full_field$tmax[] = tmax_full_field$tmax[ordered] / 10
tmax_full_field$date[] = tmax_full_field$date[ordered]
}
if ("TMIN" %in% available_datafields)  {
tmin_full_field          = sorted_data$tmin
ordered                = order(tmin_full_field$date)
tmin_full_field$tmin[] = tmin_full_field$tmin[ordered] / 10
tmin_full_field$date[] = tmin_full_field$date[ordered]
}
if ("PRCP" %in% available_datafields)  {
prcp_full_field          = sorted_data$prcp
ordered                = order(prcp_full_field$date)
prcp_full_field$prcp[] = prcp_full_field$prcp[ordered] / 10
prcp_full_field$date[] = prcp_full_field$date[ordered]
}
if ("SNOW" %in% available_datafields)  {
snow_full_field          = sorted_data$snow
ordered                = order(snow_full_field$date)
snow_full_field$snow[] = snow_full_field$snow[ordered]
snow_full_field$date[] = snow_full_field$date[ordered]
}
if ("SNWD" %in% available_datafields)  {
snwd_full_field          = sorted_data$snwd
ordered                = order(snwd_full_field$date)
snwd_full_field$snwd[] = snwd_full_field$snwd[ordered]
snwd_full_field$date[] = snwd_full_field$date[ordered]
}
remove(sorted_data,
ordered)
Days_from_1970_01_01 = as.numeric( as.Date(Date) )
index_days           = Days_from_1970_01_01      -
min(Days_from_1970_01_01) +
1
new_variable   = Days_from_1970_01_01
new_variable[] = NA
if ("TMAX" %in% available_datafields)  {
tmax             = new_variable
index_tmax       = as.numeric(tmax_full_field$date) - Days_from_1970_01_01[1] + 1
index_tmax       = index_tmax[which(index_tmax <= max(index_days)) ]
index_tmax       = index_tmax[which(index_tmax >= min(index_days)) ]
tmax[index_tmax] = tmax_full_field$tmax[index_tmax]
remove(tmax_full_field,
index_tmax)
}
if ("TMIN" %in% available_datafields)  {
tmin             = new_variable
index_tmin       = as.numeric(tmin_full_field$date) - Days_from_1970_01_01[1] + 1
index_tmin       = index_tmin[which(index_tmin <= max(index_days)) ]
index_tmin       = index_tmin[which(index_tmin >= min(index_days)) ]
tmin[index_tmin] = tmin_full_field$tmin[index_tmin]
remove(tmin_full_field,
index_tmin)
}
if ("PRCP" %in% available_datafields)  {
prcp             = new_variable
index_prcp       = as.numeric(prcp_full_field$date) - Days_from_1970_01_01[1] + 1
index_prcp       = index_prcp[which(index_prcp <= max(index_days)) ]
index_prcp       = index_prcp[which(index_prcp >= min(index_days)) ]
prcp[index_prcp] = prcp_full_field$prcp[index_prcp]
remove(prcp_full_field,
index_prcp)
}
if ("SNOW" %in% available_datafields)  {
snow             = new_variable
index_snow       = as.numeric(snow_full_field$date) - Days_from_1970_01_01[1] + 1
index_snow       = index_snow[which(index_snow <= max(index_days)) ]
index_snow       = index_snow[which(index_snow >= min(index_days)) ]
snow[index_snow] = snow_full_field$snow[index_snow]
remove(snow_full_field,
index_snow)
}
if ("SNWD" %in% available_datafields)  {
snwd             = new_variable
index_snwd       = as.numeric(snwd_full_field$date) - Days_from_1970_01_01[1] + 1
index_snwd       = index_snwd[which(index_snwd <= max(index_days)) ]
index_snwd       = index_snwd[which(index_snwd >= min(index_days)) ]
snwd[index_snwd] = snwd_full_field$snwd[index_snwd]
remove(snwd_full_field,
index_snwd)
}
remove(new_variable,
index_days)
if ("TMAX" %in% available_datafields)  {
plot(x       = Date,
y       = tmax,
type    = "p",
pch     = ".",   # as points
col     = "red",
lwd     = 1.5,
cex.lab = 1.25,
xlab    = "Date",
ylab    = "Max Temperature (deg C)",
main    = station_name_label)
}
if ("TMIN" %in% available_datafields)  {
plot(x       = Date,
y       = tmin,
type    = "p",
pch     = ".",   # as points
col     = "darkgreen",
lwd     = 1.5,
cex.lab = 1.25,
xlab    = "Date",
ylab    = "Min Temperature (deg C)",
main    = station_name_label)
}
if ("PRCP" %in% available_datafields)  {
plot(x       = Date,
y       = prcp,
type    = "p",
pch     = ".",   # as points
col     = "green",
lwd     = 1.5,
cex.lab = 1.25,
xlab    = "Date",
ylab    = "Daily Precip (mm)",
main    = station_name_label)
}
if ("SNOW" %in% available_datafields)  {
plot(x       = Date,
y       = snow,
type    = "p",
pch     = ".",   # as points
col     = "cyan",
lwd     = 1.5,
cex.lab = 1.25,
xlab    = "Date",
ylab    = "Daily Snowfall (mm)",
main    = station_name_label)
}
if ("SNWD" %in% available_datafields)  {
plot(x       = Date,
y       = snwd,
type    = "p",
pch     = ".",   # as points
col     = "darkblue",
lwd     = 1.5,
cex.lab = 1.25,
xlab    = "Date",
ylab    = "Daily Snowfall (mm)",
main    = station_name_label)
}
targ_time_series_raw = data.frame(date = Date)
if ("TMAX" %in% available_datafields)
targ_time_series_raw$max_temperature = tmax
if ("TMIN" %in% available_datafields)
targ_time_series_raw$min_temperature = tmin
if ("PRCP" %in% available_datafields)
targ_time_series_raw$precipitation   = prcp
if ("SNOW" %in% available_datafields)
targ_time_series_raw$snowfall        = snow
if ("SNWD" %in% available_datafields)
targ_time_series_raw$snowdepth       = snwd
output_file_name = paste(file_title_string,
".csv",
sep="")
write.table(x    = targ_time_series_raw,
file = output_file_name,
sep  =", ",
row.names = FALSE)
remove(targ_time_series_raw)
netcdf_time_dim  = ncdim_def(name  = "time",
units = "days since 1970-01-01 00:00:00",
val   = Days_from_1970_01_01,
unlim = TRUE,
calendar="standard")
fill_value = 9.96921e+36
netcdf_lat = ncvar_def(nam      = "latitude",
units    = "degrees_north",
dim      = list(),
missval  = fill_value,
longname = "Latitude",
prec     = "single")
netcdf_lon = ncvar_def(nam      = "longitude",
units    = "degrees_east",
dim      = list(),
missval  = fill_value,
longname = "Longitue",
prec     = "single")
netcdf_alt = ncvar_def(nam      = "altitude",
units    = "m",
dim      = list(),
missval  = fill_value,
longname = "Elevation",
prec     = "single")
netcdf_available_variables = list(netcdf_lat,
netcdf_lon,
netcdf_alt)
if ("TMAX" %in% available_datafields) {
netcdf_tmax = ncvar_def(nam      = "maximum_air_temperature",
units    = "deg C",
dim      = netcdf_time_dim,
missval  = fill_value,
longname = "2-m Maximum Daily Air Temperature",
prec     = "single")
list.append(netcdf_available_variables,
netcdf_tmax)
}
if ("TMIN" %in% available_datafields) {
netcdf_tmin = ncvar_def(nam      = "minimum_air_temperature",
units    = "deg C",
dim      = netcdf_time_dim,
missval  = fill_value,
longname = "2-m Minimium Daily Air Temperature",
prec     = "single")
list.append(netcdf_available_variables,
netcdf_tmin)
}
if ("PRCP" %in% available_datafields) {
netcdf_prcp = ncvar_def(nam      = "precipitation_amount",
units    = "kg m-2",
dim      = netcdf_time_dim,
missval  = fill_value,
longname = "Daily Total Precipitation",
prec     = "single")
list.append(netcdf_available_variables,
netcdf_prcp)
}
