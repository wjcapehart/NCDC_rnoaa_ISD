---
title: "rnoaa  Notebook"
output: html_notebook
---

https://www.ncdc.noaa.gov/isd

__Development_Edition_Do_Not_Use_Until_Released__

RNOAA R test for the ISD/DS3505 Datasets

Pardon the typos; they are legion.

To begin with we will use the "rnoaa" library.

It is also handy to have the "lubridate" library to manage the time coordinate data.  

ISD Parsing is sone with the "isdparser"

You will need to install all three

I also included  the "openair" library for wind roses

Something to be aware of before we start.  

These are an merger of several report message types, METARs (Hourlies), SPECIs (special reports that supplement the METARs), and 3-hrly but more comprehensive SYNOPs.  Most are derived for use at airports and thus have more than one cloud field (low, middle and high). The data archiving is designed to house any of the messages in one single record.

For some fields like temperature, pressure, humidity and wind speed, this isn't too much of a problem.  But for other fields like cloud and precip and significant weather that will vary with the type of report message.

```{r}
library("lubridate")
library("isdparser")
library("rnoaa")
library("openair")
library("ncdf4")
```

To target a given station location you will need two catalog codes

The USAF Code and the WBAN code.

If you didn't work in the old Asheville Federal Building in the 80s before they moved and don't know what file cabinet the station history info is kept, there is hope.

If you have the latitude and longitude and radius in KM you can pull those fields from  using the isd_station_search function.

```{r}
stations_near_targ = isd_stations_search(lat    =   44,  # degrees_north
                                         lon    = -103,  # degrees_east
                                         radius =  100)  # km

file_title_string = "KRAP"
name_of_station   = "Rapid City Regional Airport"

print(stations_near_targ)
```

So for Rapid City Regional Airport (KRAP) which probably has the best reporting fidelity since it's a First Order Station for NOAA, and for your period, you will want to use the following stationID pair.

I am not sure as to the quality or reliability of Elsworth (KRCA), Custer (KCUT) or Spearfish (KSPF) since they are not affiliated with an NWS office.

```{r}
target_usaf = 726620
target_wban =  24090
target_year =   2010

station_name_label = paste(name_of_station, 
                           target_year)

output_file_name = paste(file_title_string,
                         target_year,
                         ".csv",
                         sep="")

```

To extract the data (and this can take a few minutes since you are digging on the NOAA servers...) 

use the isd command following this example.  The original data is kept in a compressed "tarball" with one tarball per year.

This also has the option for multiprocessing but you probably don't need it.

```{r}
targ_data = isd(usaf = target_usaf,  # your usaf number
                wban = target_wban,  # your wban number
                year = target_year,  # your year
                progress=TRUE)       # shows prograss as you go

print(targ_data)

```



You will want to fix the date.  In the ISD format it is split between calendar day (UTC time always) and clock hour (UTC time always)

This can be done with the lubridate function ymd_hm()

```{r}
targ_data$date_time = ymd_hm(sprintf("%s %s",
                                      as.character(targ_data$date),
                                      targ_data$time))

targ_data$date = targ_data$date_time 

```


The data is parsed as strings.  So you'll have to use the as.numeric() a lot
Missing fields are typically ID'ed as 9999 in the original data

```{r}


targ_data$temperature[targ_data$temperature == "+9999"]                   = NA 

targ_data$temperature_dewpoint[targ_data$temperature_dewpoint == "+9999"] = NA

targ_data$air_pressure[targ_data$air_pressure == "99999"]                 = NA

targ_data$wind_speed[targ_data$wind_speed == "9999"]                     = NA

targ_data$wind_direction[targ_data$wind_direction == "999"]             = NA




```

Some of these fields, but not all, are managed with the isd_transform() function with respect to scaling

temp/dew point (deg C) converted from 10ths of degree
mean sea level pressure (hPa) converted from 10ths of hPa
wind speed     (m s-1) converted from 10ths of m s-1
wind direction (compass decimal degrees) 

Precip is also processed but this data set is an merger of both hourly, 3-hrly, 6-hrly, 12-hrly, 24-hrly data depending on the report message that's being archived.  T

```{r}

precip_workspace_time_interval = as.numeric(targ_data$AA1_period_quantity_hrs)


precip_workspace_depth         = as.numeric(targ_data$AA1_depth)
precip_workspace_depth[precip_workspace_depth == 9999]                   = NA 

precip_workspace_depth_01hrly =  precip_workspace_depth
precip_workspace_depth_03hrly =  precip_workspace_depth
precip_workspace_depth_06hrly =  precip_workspace_depth
precip_workspace_depth_12hrly =  precip_workspace_depth
precip_workspace_depth_24hrly =  precip_workspace_depth

precip_workspace_depth_01hrly[precip_workspace_time_interval != 01]  =  NA
precip_workspace_depth_03hrly[precip_workspace_time_interval != 03]  =  NA
precip_workspace_depth_06hrly[precip_workspace_time_interval != 06]  =  NA
precip_workspace_depth_12hrly[precip_workspace_time_interval != 12]  =  NA
precip_workspace_depth_24hrly[precip_workspace_time_interval != 24]  =  NA

targ_data$precip_01hr = precip_workspace_depth_01hrly
targ_data$precip_03hr = precip_workspace_depth_03hrly
targ_data$precip_06hr = precip_workspace_depth_06hrly
targ_data$precip_12hr = precip_workspace_depth_12hrly
targ_data$precip_24hr = precip_workspace_depth_24hrly

```





```{r}

targ_data = isd_transform(targ_data)

# patch the wind direction so it's 0 degrees when the wind speed is missing

targ_data$wind_direction[targ_data$wind_speed == 0]             = 0


```



Cloud Cover is held in several positions in the dataset.  Once again this is because the data is designed for use for aerodrome use.  

I am setting it up to give you the "GF1 group" which is the total cloud cover for all flight levels.  These fields are often archived in "octaves" or eights and I'll be converting them to fractions for you.  IN cases of "obscured sky" caused by fog or smoke, I will label it 100% for total obscured sky or 50% covered for partial obscured skies.    
print

```{r}

targ_data$GF1_total_cloud_cover_fraction = as.numeric(targ_data$GF1_coverage)

# 00: None, SKC or CLR

targ_data$GF1_total_cloud_cover_fraction[targ_data$GF1_total_cloud_cover_fraction==00] = 0.00

# 01: One okta - 1/10 or less but not zero

targ_data$GF1_total_cloud_cover_fraction[targ_data$GF1_total_cloud_cover_fraction==01] = 1.0 / 8.0

# 02: Two oktas - 2/10 ‑ 3/10, or FEW

targ_data$GF1_total_cloud_cover_fraction[targ_data$GF1_total_cloud_cover_fraction==02] = 2.0 / 8.0

# 03: Three oktas - 4/10

targ_data$GF1_total_cloud_cover_fraction[targ_data$GF1_total_cloud_cover_fraction==03] = 3.0 / 8.0

# 04: Four oktas - 5/10, or SCT

targ_data$GF1_total_cloud_cover_fraction[targ_data$GF1_total_cloud_cover_fraction==04] = 4.0 / 8.0

# 05: Five oktas - 6/10

targ_data$GF1_total_cloud_cover_fraction[targ_data$GF1_total_cloud_cover_fraction==05] = 5.0 / 8.0

# 06: Six oktas - 7/10 ‑ 8/10

targ_data$GF1_total_cloud_cover_fraction[targ_data$GF1_total_cloud_cover_fraction==06] = 6.0 / 8.0

# 07: Seven oktas - 9/10 or more but not 10/10, or BKN

targ_data$GF1_total_cloud_cover_fraction[targ_data$GF1_total_cloud_cover_fraction==07] = 7.0 / 8.0

# 08: Eight oktas - 10/10, or OVC

targ_data$GF1_total_cloud_cover_fraction[targ_data$GF1_total_cloud_cover_fraction==08] = 8.0 / 8.0

# 09: Sky obscured, or cloud amount cannot be estimated

targ_data$GF1_total_cloud_cover_fraction[targ_data$GF1_total_cloud_cover_fraction==09] = 8.0 / 8.0

# 10: Partial obscuration

targ_data$GF1_total_cloud_cover_fraction[targ_data$GF1_total_cloud_cover_fraction==10] = 4.0 / 8.0

# 11: Thin scattered

targ_data$GF1_total_cloud_cover_fraction[targ_data$GF1_total_cloud_cover_fraction==11] = 2.0 / 8.0

# 12: Scattered

targ_data$GF1_total_cloud_cover_fraction[targ_data$GF1_total_cloud_cover_fraction==12] = 4.0 / 8.0

# 13: Dark scattered

targ_data$GF1_total_cloud_cover_fraction[targ_data$GF1_total_cloud_cover_fraction==13] = 5.0 / 8.0

# 14: Thin broken

targ_data$GF1_total_cloud_cover_fraction[targ_data$GF1_total_cloud_cover_fraction==14] = 6.0 / 8.0

# 15: Broken

targ_data$GF1_total_cloud_cover_fraction[targ_data$GF1_total_cloud_cover_fraction==15] = 7.0 / 8.0

# 16: Dark broken

targ_data$GF1_total_cloud_cover_fraction[targ_data$GF1_total_cloud_cover_fraction==16] = 8.0 / 8.0

# 17: Thin overcast

targ_data$GF1_total_cloud_cover_fraction[targ_data$GF1_total_cloud_cover_fraction==17] = 4.0 / 8.0

# 18: Overcast

targ_data$GF1_total_cloud_cover_fraction[targ_data$GF1_total_cloud_cover_fraction==18] = 8.0 / 8.0

# 19: Dark overcast

targ_data$GF1_total_cloud_cover_fraction[targ_data$GF1_total_cloud_cover_fraction==19] = 8.0 / 8.0

# 99: Missing

targ_data$GF1_total_cloud_cover_fraction[targ_data$GF1_total_cloud_cover_fraction==99] = NA


```


And to plot everything out...

Temperature

```{r}

plot(x       = targ_data$date_time,
     y       = targ_data$temperature, 
     type    = "l", 
     col     = "red", 
     lwd     = 1.5, 
     cex.lab = 1.25,
     xlab    = "Date", 
     ylab    = "Temperature (deg C)",
     main    = station_name_label)

```


Dew Point

```{r}


plot(x       = targ_data$date_time,
     y       = targ_data$temperature_dewpoint, 
     type    = "l", 
     col     = "darkgreen", 
     lwd     = 1.5, 
     cex.lab = 1.25,
     xlab    = "Date", 
     ylab    = "Dew Point (deg C)",
     main    = station_name_label)

```

Cloud Fraction 
```{r}


plot(x       = targ_data$date_time,
     y       = targ_data$GF1_total_cloud_cover_fraction, 
     type    = "l", 
     col     = "grey", 
     lwd     = 1.5, 
     cex.lab = 1.25,
     xlab    = "Date", 
     ylab    = "Cloud Cover (fraction)",
     main    = station_name_label)

```




Pressure 

```{r}


plot(x       = targ_data$date_time,
     y       = targ_data$air_pressure, 
     type    = "l", 
     col     = "blue", 
     lwd     = 1.5, 
     cex.lab = 1.25,
     xlab    = "Date", 
     ylab    = "MSL Pressure (mb)",
     main    = station_name_label)

```



Wind Speed 

```{r}


plot(x       = targ_data$date_time,
     y       = targ_data$wind_speed, 
     type    = "l", 
     col     = "darkblue", 
     lwd     = 1.5, 
     cex.lab = 1.25,
     xlab    = "Date", 
     ylab    = "Wind Speed (m s-1)",
     main    = station_name_label)

```


Wind Rose 

```{r}

windrose_frame = data.frame(date      = targ_data$date_time,
                            ws        = targ_data$wind_speed,
                            wd        = targ_data$wind_direction,
                            longitude = targ_data$longitude,
                            latitude  = targ_data$latitude)



windRose(mydata     = windrose_frame, 
         ws         = "ws", 
         wd         = "wd",
         type       = "year",
         hemisphere = "northern",
         main       = station_name_label)


windRose(mydata     = windrose_frame, 
         ws         = "ws", 
         wd         = "wd",
         type       = "season",
         hemisphere = "northern",
         main       = station_name_label)


```

Finally let's put everything into a single time frame since we have observations at several times.  We can interpolate the data to the nearest hour.

We do this by first creating a regularly spaced time vector


```{r}

start_date = as.POSIXct(paste(target_year,
                              "-01-01 00:00:00 UTC",
                              sep=""),
                        tz = "UTC")

end_date   = as.POSIXct(paste(target_year,
                              "-12-31 00:00:00 UTC",
                              sep=""),
                        tz = "UTC")

hour_time = seq.POSIXt(from = start_date,
                        to   = end_date,
                        by   = "1 hour",
                        tz   = "UTC")



```

We then interpolate between the various fields and frame them... 

```{r}

targ_time_series                  = data.frame(date = hour_time)

targ_time_series$temperature_degC = approx(x      = targ_data$date_time,
                                           y      = targ_data$temperature,
                                           method = "linear",
                                           xout   = hour_time)$y
                              
targ_time_series$dewpoint_degC    = approx(x      = targ_data$date_time,
                                           y      = targ_data$temperature_dewpoint,
                                           method = "linear",
                                           xout   = hour_time)$y 
                              
targ_time_series$cloud_fraction   = approx(x      = targ_data$date_time,
                                           y      = targ_data$GF1_total_cloud_cover_fraction,
                                           method = "linear",
                                           xout   = hour_time)$y 
                              
targ_time_series$press_msl_hPa    = approx(x      = targ_data$date_time,
                                           y      = targ_data$air_pressure,
                                           method = "linear",
                                           xout   = hour_time)$y
                              
targ_time_series$wind_spd_ms      = approx(x      = targ_data$date_time,
                                           y      = targ_data$wind_speed,
                                           method = "linear",
                                           xout   = hour_time)$y
                              
targ_time_series$wind_dir_degrees  = approx(x     = targ_data$date_time,
                                           y      = targ_data$wind_direction,
                                           method = "linear",
                                           xout   = hour_time)$y

targ_time_series$ISD_precip_01hr   = approx(x      = targ_data$date_time,
                                            y      = targ_data$precip_01hr,
                                            method = "constant",
                                            xout   = hour_time)$y

targ_time_series$ISD_precip_03hr   = approx(x      = targ_data$date_time,
                                            y      = targ_data$precip_03hr,
                                            method = "constant",
                                            xout   = hour_time)$y

targ_time_series$ISD_precip_06hr   = approx(x      = targ_data$date_time,
                                            y      = targ_data$precip_06hr,
                                            method = "constant",
                                            xout   = hour_time)$y

#targ_time_series$ISD_precip_12hr   = approx(x      = targ_data$date_time,
#                                            y      = targ_data$precip_12hr,
#                                            method = "constant",
#                                            xout   = hour_time)$y

targ_time_series$ISD_precip_24hr   = approx(x      = targ_data$date_time,
                                            y      = targ_data$precip_24hr,
                                            method = "constant",
                                            xout   = hour_time)$y
print(targ_time_series)
```

And send it to an ASCII file

```{r}

output_file_name = paste(file_title_string,
                         "_HOURLY_",
                         target_year,
                         ".csv",
                         sep="")

write.table(x    = targ_time_series, 
            file = output_file_name, 
            sep  =", ",
            row.names = FALSE)

```


Now let's make a "raw" datafile for all observations regardless what part of the hour they are taken.

```{r}

targ_time_series_raw                      = data.frame(date = targ_data$date_time)
targ_time_series_raw$temperature_dewpoint = targ_data$temperature_dewpoint
targ_time_series_raw$cloud_cover_fraction = targ_data$GF1_total_cloud_cover_fraction
targ_time_series_raw$air_pressure         = targ_data$air_pressure

targ_time_series_raw$wind_speed       = targ_data$wind_speed
targ_time_series_raw$wind_dir_degrees = targ_data$wind_direction

targ_time_series_raw$ISD_precip_01hr = targ_data$precip_01hr
targ_time_series_raw$ISD_precip_03hr = targ_data$precip_03hr
targ_time_series_raw$ISD_precip_06hr = targ_data$precip_06hr
targ_time_series_raw$ISD_precip_12hr = targ_data$precip_12hr
targ_time_series_raw$ISD_precip_24hr = targ_data$precip_24hr

  
output_file_name = paste(file_title_string,
                         "_RAW_",
                         target_year,
                         ".csv",
                         sep="")

write.table(x    = targ_time_series_raw, 
            file = output_file_name, 
            sep  =", ",
            row.names = FALSE)

```


This section prepeares the output for a formal NetCDF file.

This section is in preparation. 


```{r}

```

